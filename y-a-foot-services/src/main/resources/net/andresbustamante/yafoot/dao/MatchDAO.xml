<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="net.andresbustamante.yafoot.dao.MatchDAO">
    <select id="isCodeExistant" resultType="boolean">
        SELECT COUNT(*)
        FROM t_match mat
        WHERE mat.mat_code = #{code}
    </select>

    <select id="chercherMatchParCode" resultMap="matchComplet">
        SELECT mat.mat_id                   AS id,
               mat.mat_code                 AS code,
               mat.mat_date                 AS dateMatch,
               mat.mat_description          AS description,
               mat.mat_num_joueurs_min      AS nbJoueursMin,
               mat.mat_num_joueurs_max      AS nbJoueursMax,
               mat.mat_num_joueurs_inscrits AS nbJoueursInscrits,
               mat.mat_covoiturage_actif    AS covoiturageActif,
               mat.mat_partage_actif        AS partageActif,
               sit.sit_id                   AS idSite,
               sit.sit_nom                  AS nomSite,
               sit.sit_adresse              AS adresseSite,
               sit.sit_telephone            AS telephoneSite,
               sit.sit_latitude             AS latitudeSite,
               sit.sit_longitude            AS longitudeSite,
               cre.jou_id                   AS idCreateur,
               cre.jou_nom                  AS nomCreateur,
               cre.jou_prenom               AS prenomCreateur,
               cre.jou_email                AS emailCreateur,
               jou.jou_id                   AS idJoueur,
               jou.jou_prenom               AS prenomJoueur,
               jou.jou_email                AS emailJoueur,
               voi.voi_id                   AS idVoiture,
               voi.voi_num_places           AS nbPlacesVoiture
        FROM t_match mat
            JOIN t_site sit ON mat.mat_site_fk = sit.sit_id
            JOIN t_joueur cre ON mat.mat_createur_fk = cre.jou_id
            LEFT JOIN t_joueur_match jma ON mat.mat_id = jma.jma_match_fk
            LEFT JOIN t_joueur jou ON jma.jma_joueur_fk = jou.jou_id
            LEFT JOIN t_voiture voi ON jma.jma_voiture_fk = voi.voi_id
        WHERE mat.mat_code = #{code}
    </select>

    <select id="chercherMatchsParJoueur" resultMap="matchComplet">
        SELECT mat.mat_id                   AS id,
               mat.mat_code                 AS code,
               mat.mat_date                 AS dateMatch,
               mat.mat_description          AS description,
               mat.mat_num_joueurs_min      AS nbJoueursMin,
               mat.mat_num_joueurs_max      AS nbJoueursMax,
               mat.mat_num_joueurs_inscrits AS nbJoueursInscrits,
               mat.mat_covoiturage_actif    AS covoiturageActif,
               mat.mat_partage_actif        AS partageActif,
               sit.sit_id                   AS idSite,
               sit.sit_nom                  AS nomSite,
               sit.sit_adresse              AS adresseSite,
               sit.sit_telephone            AS telephoneSite,
               sit.sit_latitude             AS latitudeSite,
               sit.sit_longitude            AS longitudeSite,
               cre.jou_id                   AS idCreateur,
               cre.jou_nom                  AS nomCreateur,
               cre.jou_prenom               AS prenomCreateur,
               cre.jou_email                AS emailCreateur,
               jou.jou_id                   AS idJoueur,
               jou.jou_prenom               AS prenomJoueur,
               jou.jou_email                AS emailJoueur,
               voi.voi_id                   AS idVoiture,
               voi.voi_num_places           AS nbPlacesVoiture
        FROM t_match mat
            JOIN t_site sit ON mat.mat_site_fk = sit.sit_id
            JOIN t_joueur cre ON mat.mat_createur_fk = cre.jou_id
            JOIN t_joueur_match jma ON mat.mat_id = jma.jma_match_fk
            LEFT JOIN t_joueur jou ON jma.jma_joueur_fk = jou.jou_id
            LEFT JOIN t_voiture voi ON jma.jma_voiture_fk = voi.voi_id
        WHERE jma.jma_joueur_fk = #{id} AND mat.mat_date > #{date}
    </select>

    <select id="chercherMatchParId" resultMap="matchComplet">
        SELECT mat.mat_id                   AS id,
               mat.mat_code                 AS code,
               mat.mat_date                 AS dateMatch,
               mat.mat_description          AS description,
               mat.mat_num_joueurs_min      AS nbJoueursMin,
               mat.mat_num_joueurs_max      AS nbJoueursMax,
               mat.mat_num_joueurs_inscrits AS nbJoueursInscrits,
               mat.mat_covoiturage_actif    AS covoiturageActif,
               mat.mat_partage_actif        AS partageActif,
               cre.jou_id                   AS idCreateur,
               cre.jou_nom                  AS nomCreateur,
               cre.jou_prenom               AS prenomCreateur,
               cre.jou_email                AS emailCreateur,
               sit.sit_id                   AS idSite,
               sit.sit_nom                  AS nomSite,
               sit.sit_adresse              AS adresseSite,
               sit.sit_telephone            AS telephoneSite,
               sit.sit_latitude             AS latitudeSite,
               sit.sit_longitude            AS longitudeSite
        FROM t_match mat
            JOIN t_site sit ON mat.mat_site_fk = sit.sit_id
            JOIN t_joueur cre on mat.mat_createur_fk = cre.jou_id
        WHERE mat.mat_id = #{id}
    </select>

    <insert id="creerMatch" useGeneratedKeys="true">
        <selectKey keyProperty="match.id" resultType="int" order="BEFORE">
            SELECT NEXTVAL('s_match') AS id;
        </selectKey>

        INSERT INTO t_match (
            mat_id,
            mat_date,
            mat_description,
            mat_num_joueurs_min,
            mat_num_joueurs_max,
            mat_site_fk,
            mat_code,
            mat_date_creation,
            mat_covoiturage_actif,
            mat_partage_actif,
            mat_createur_fk
        ) VALUES (
            #{match.id},
            #{match.dateMatch},
            #{match.description},
            #{match.nbJoueursMin},
            #{match.nbJoueursMax},
            #{match.site.id},
            #{match.code},
            NOW(),
            #{match.covoiturageActif},
            #{match.partageActif},
            #{match.createur.id}
        )
    </insert>

    <insert id="inscrireJoueurMatch">
        <choose>
            <when test="voiture == null">
                INSERT INTO t_joueur_match (jma_match_fk, jma_joueur_fk)
                VALUES (#{match.id}, #{joueur.id})
            </when>
            <otherwise>
                INSERT INTO t_joueur_match (jma_match_fk, jma_joueur_fk, jma_voiture_fk)
                VALUES (#{match.id}, #{joueur.id}, #{voiture.id})
            </otherwise>
        </choose>
    </insert>

    <delete id="desinscrireJoueurMatch">
        DELETE FROM t_joueur_match WHERE jma_joueur_fk = #{joueur.id} AND jma_match_fk = #{match.id}
    </delete>

    <select id="isJoueurInscritMatch" resultType="boolean">
        SELECT COUNT(*)
        FROM t_joueur_match jma
        WHERE jma.jma_joueur_fk = #{joueur.id} AND jma.jma_match_fk = #{match.id}
    </select>

    <delete id="desinscrireJoueur">
        DELETE FROM t_joueur_match WHERE jma_joueur_fk = #{joueur.id}
    </delete>

    <update id="notifierInscriptionJoueur">
        UPDATE t_match
        SET mat_num_joueurs_inscrits = mat_num_joueurs_inscrits + 1
        WHERE mat_id = #{match.id}
    </update>

    <update id="notifierDesinscriptionJoueur">
        UPDATE t_match
        SET mat_num_joueurs_inscrits = mat_num_joueurs_inscrits - 1
        WHERE mat_id = #{match.id}
    </update>

    <resultMap id="matchComplet" type="net.andresbustamante.yafoot.model.Match">
        <id property="id" column="id"/>
        <result property="code" column="code"/>
        <result property="dateMatch" column="dateMatch"/>
        <result property="description" column="description"/>
        <result property="nbJoueursMin" column="nbJoueursMin"/>
        <result property="nbJoueursMax" column="nbJoueursMax"/>
        <result property="nbJoueursInscrits" column="nbJoueursInscrits"/>
        <result property="covoiturageActif" column="covoiturageActif"/>
        <result property="partageActif" column="partageActif"/>
        <association property="site" javaType="net.andresbustamante.yafoot.model.Site">
            <id column="idSite" property="id"/>
            <result column="nomSite" property="nom"/>
            <result column="adresseSite" property="adresse"/>
            <result column="telephoneSite" property="telephone"/>
            <association property="localisation" javaType="net.andresbustamante.yafoot.model.CoordonneesGPS">
                <result column="latitudeSite" property="latitude"/>
                <result column="longitudeSite" property="longitude"/>
            </association>
        </association>
        <association property="createur" javaType="net.andresbustamante.yafoot.model.Utilisateur">
            <id column="idCreateur" property="id"/>
            <result column="nomCreateur" property="nom"/>
            <result column="prenomCreateur" property="prenom"/>
            <result column="emailCreateur" property="email"/>
        </association>
        <collection property="inscriptions" ofType="net.andresbustamante.yafoot.model.Inscription">
            <id column="idJoueur" property="id.idJoueur" />
            <association property="joueur" javaType="net.andresbustamante.yafoot.model.Joueur">
                <id column="idJoueur" property="id" />
                <result column="prenomJoueur" property="prenom" />
                <result column="emailJoueur" property="email" />
            </association>
            <association property="voiture" javaType="net.andresbustamante.yafoot.model.Voiture">
                <id column="idVoiture" property="id" />
                <result column="nbPlacesVoiture" property="nbPlaces" />
            </association>
        </collection>
    </resultMap>
</mapper>