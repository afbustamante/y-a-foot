<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="net.andresbustamante.yafoot.dao.MatchDAO">
    <select id="isCodeExistant" resultType="boolean">
        SELECT COUNT(*)
        FROM yafoot.t_match mat
        WHERE mat.mat_code = #{code}
    </select>

    <select id="chercherMatchParCode" resultMap="matchComplet">
        SELECT
            mat.mat_id              AS id,
            mat.mat_code            AS code,
            mat.mat_date            AS dateMatch,
            mat.mat_description     AS description,
            mat.mat_num_joueurs_min AS numJoueursMin,
            mat.mat_num_joueurs_max AS numJoueursMax,
            sit.sit_id              AS idSite,
            sit.sit_nom             AS nomSite,
            sit.sit_adresse         AS adresseSite,
            sit.sit_telephone       AS telephoneSite,
            sit.sit_latitude        AS latitudeSite,
            sit.sit_longitude       AS longitudeSite
        FROM yafoot.t_match mat
            JOIN yafoot.t_site sit ON mat.mat_site_fk = sit.sit_id
        WHERE mat.mat_code = #{code}
    </select>

    <select id="chercherMatchsParJoueur" resultMap="matchComplet">
        SELECT
            mat.mat_id              AS id,
            mat.mat_code            AS code,
            mat.mat_date            AS dateMatch,
            mat.mat_description     AS description,
            mat.mat_num_joueurs_min AS numJoueursMin,
            mat.mat_num_joueurs_max AS numJoueursMax,
            sit.sit_id              AS idSite,
            sit.sit_nom             AS nomSite,
            sit.sit_adresse         AS adresseSite,
            sit.sit_telephone       AS telephoneSite,
            sit.sit_latitude        AS latitudeSite,
            sit.sit_longitude       AS longitudeSite
        FROM yafoot.t_match mat
            JOIN yafoot.t_site sit ON mat.mat_site_fk = sit.sit_id
            JOIN yafoot.t_joueur_match jma ON mat.mat_id = jma.jma_match_fk
        WHERE jma.jma_joueur_fk = #{id} AND mat.mat_date > #{date}
    </select>

    <select id="chercherMatchParId" resultType="net.andresbustamante.yafoot.model.Match">
        SELECT
            mat.mat_id              AS id,
            mat.mat_code            AS code,
            mat.mat_date            AS dateMatch,
            mat.mat_description     AS description,
            mat.mat_num_joueurs_min AS numJoueursMin,
            mat.mat_num_joueurs_max AS numJoueursMax,
            sit.sit_id              AS idSite,
            sit.sit_nom             AS nomSite,
            sit.sit_adresse         AS adresseSite,
            sit.sit_telephone       AS telephoneSite,
            sit.sit_latitude        AS latitudeSite,
            sit.sit_longitude       AS longitudeSite
        FROM yafoot.t_match mat
            JOIN yafoot.t_site sit ON mat.mat_site_fk = sit.sit_id
        WHERE mat.mat_id = #{id}
    </select>

    <insert id="creerMatch" useGeneratedKeys="true">
        <selectKey keyProperty="match.id" resultType="int" order="BEFORE">
            SELECT NEXTVAL('yafoot.s_match') AS id;
        </selectKey>

        INSERT INTO yafoot.t_match (mat_id, mat_date, mat_description, mat_num_joueurs_min, mat_num_joueurs_max,
        mat_site_fk, mat_code, mat_date_creation) VALUES (#{match.id}, #{match.dateMatch}, #{match.description},
        #{match.numJoueursMin}, #{match.numJoueursMax}, #{match.site.id}, #{match.code}, NOW())
    </insert>

    <insert id="inscrireJoueurMatch">
        INSERT INTO yafoot.t_joueur_match (jma_match_fk, jma_joueur_fk, jma_voiture_fk)
        VALUES (#{match.id}, #{joueur.id}, #{voiture.id})
    </insert>

    <select id="isJoueurInscritMatch" resultType="boolean">
        SELECT COUNT(*)
        FROM yafoot.t_joueur_match jma
        WHERE jma.jma_joueur_fk = #{joueur.id} AND jma.jma_match_fk = #{match.id}
    </select>

    <resultMap id="matchComplet" type="net.andresbustamante.yafoot.model.Match">
        <id property="id" column="id"/>
        <result property="code" column="code"/>
        <result property="dateMatch" column="dateMatch"/>
        <result property="description" column="description"/>
        <result property="numJoueursMin" column="numJoueursMin"/>
        <result property="numJoueursMax" column="numJoueursMax"/>
        <association property="site" javaType="net.andresbustamante.yafoot.model.Site">
            <result column="idSite" property="id"/>
            <result column="nomSite" property="nom"/>
            <result column="adresseSite" property="adresse"/>
            <result column="telephoneSite" property="telephone"/>
            <association property="localisation" javaType="net.andresbustamante.yafoot.model.Coordonnees">
                <result column="latitudeSite" property="latitude"/>
                <result column="longitudeSite" property="longitude"/>
            </association>
        </association>
    </resultMap>
</mapper>